name: upterm
on:
  workflow_dispatch:
jobs:
  upterm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - name: upterm
        run: |
          export PATH=$HOME/.nix-profile/bin:$PATH
          nix profile install nixpkgs#upterm nixpkgs#tmux nixpkgs#vim
          ssh-keygen -q -t rsa -N "" -f ~/.ssh/id_rsa
          ssh-keygen -q -t ed25519 -N "" -f ~/.ssh/id_ed25519
          echo -e "Host *\nStrictHostKeyChecking no\nCheckHostIP no\nTCPKeepAlive yes\nServerAliveInterval 30\nServerAliveCountMax 180\nVerifyHostKeyDNS yes\nUpdateHostKeys yes\n" >> $HOME/.ssh/config
          ssh-keyscan uptermd.upterm.dev 2> /dev/null >> ~/.ssh/known_hosts
          cat <(cat ~/.ssh/known_hosts | awk '{ print "@cert-authority * " $2 " " $3 }') >> ~/.ssh/known_hosts
          mkdir -p $HOME/.upterm
          tmux new -d -s upterm -x 132 -y 43 "upterm host --accept --github-user vic | tee $HOME/.upterm/out.log"
          tmux set -t upterm window-size largest
          while true; do date; echo "Connecting"; grep 'SSH Session:' $HOME/.upterm/out.log | head -n 1 ; sleep 10; if grep 'Client joined' $HOME/.upterm/upterm.log; then break ; fi  ; done
          while true; do date; echo "Working"; sleep 360; if ! test -f $HOME/.upterm/*.sock; then break ; fi ; done
