# Rescue Mode Rebuild Instructions - tachi

**Created:** 2025-10-23 19:57:17
**System:** tachi (Intel 11th Gen i7-1165G7)
**Issue:** Cannot use sudo (empty password + mutableUsers=false)

## Problem Summary

The system is in a catch-22:
- Current running system has `initialHashedPassword = ""` (empty password)
- Can't use `sudo` without a password
- Can't rebuild to apply the new password hash
- Configuration updated with password hash but not applied yet

## Solution: Boot into Rescue/Single-User Mode

### Method 1: systemd Rescue Mode (Recommended)

**Step 1: Reboot and access GRUB**
```bash
# Reboot the system
reboot
```

**Step 2: Edit GRUB entry**
1. When GRUB menu appears, press `e` to edit the boot entry
2. Find the line starting with `linux` (kernel command line)
3. Add `systemd.unit=rescue.target` to the end of that line
4. Press `Ctrl+X` or `F10` to boot

**Step 3: You'll be dropped into a root shell**
```bash
# You're now root! No password needed
whoami  # Should show: root

# Mount the filesystem read-write (if needed)
mount -o remount,rw /

# Navigate to your flake
cd /run/media/lessuseless/Ventoy/nixos-configs/dendrix/lul

# Rebuild with the new configuration
nix run .#os-rebuild -- switch

# Or use nixos-rebuild directly
nixos-rebuild switch --flake .#tachi
```

**Step 4: Exit and reboot**
```bash
exit
# System will reboot normally
```

### Method 2: Single-User Mode (Alternative)

**Step 1: Edit GRUB**
- Same as Method 1, but add `single` or `systemd.unit=emergency.target` instead

**Step 2: Execute rebuild**
- Same commands as Method 1 Step 3

### Method 3: Boot from Ventoy USB

If you have a NixOS installer on your Ventoy drive:

**Step 1: Boot from USB**
- Boot the NixOS installer from Ventoy

**Step 2: Mount your system**
```bash
# Mount the btrfs root
mount -o subvol=@root /dev/nvme0n1p2 /mnt

# Mount other necessary subvolumes
mount -o subvol=@nix /dev/nvme0n1p2 /mnt/nix
mount -o subvol=@persist /dev/nvme0n1p2 /mnt/persist

# Mount the flake location (Ventoy drive)
mkdir -p /mnt/run/media/lessuseless/Ventoy
mount /dev/sdb1 /mnt/run/media/lessuseless/Ventoy

# Mount boot partition
mount /dev/nvme0n1p1 /mnt/boot

# Chroot into the system
nixos-enter
```

**Step 3: Rebuild from chroot**
```bash
cd /run/media/lessuseless/Ventoy/nixos-configs/dendrix/lul
nix run .#os-rebuild -- switch
```

**Step 4: Exit and reboot**
```bash
exit  # Exit chroot
reboot
```

## After Successful Rebuild

**Step 1: Test sudo with new password**
```bash
# Password is: temp123
sudo whoami
# Should prompt for password and show: root
```

**Step 2: Fix home-manager conflicts**
```bash
rm /home/lessuseless/.config/git/ignore
rm /home/lessuseless/.config/nvim
sudo systemctl start home-manager-lessuseless.service
systemctl status home-manager-lessuseless.service
```

**Step 3: Test Ctrl key**
- Ctrl+C should copy text
- Ctrl+V should paste text
- Terminal Ctrl+C should interrupt processes

**Step 4: Verify time-machine service**
```bash
# Check if btrbk and httm are installed
which btrbk httm

# Check fish abbreviations
nos --help  # Should show: nix run path:$HOME/.flake#os-rebuild -- switch
ht --help   # Should show httm help

# Check time-machine service
systemctl status btrbk-time-machine.timer
```

**Step 5: Change to a real password (IMPORTANT)**
```bash
# Generate a new password hash
mkpasswd -m sha-512
# Enter your real password twice

# Edit modules/lessuseless/user.nix
# Replace the temp123 hash with your new hash
# Also consider removing: security.sudo.wheelNeedsPassword = false;

# Rebuild
sudo nix run .#os-rebuild -- switch
```

## What Changed in This Configuration

### Files Modified:
- `modules/hosts/tachi/configuration.nix` - Removed macos-keys
- `modules/lessuseless/user.nix` - Added password hash, wheelNeedsPassword=false
- `modules/lessuseless/impermanence.nix` - Fixed to use home.persistence
- `modules/lessuseless/_fish/abbrs.nix` - Added nos/nob/not abbreviations

### Files Created:
- `modules/lessuseless/services/time-machine.nix` - Backup service
- `modules/lessuseless/services/README.md` - Service documentation
- `modules/hosts/tachi/time-machine.nix` - tachi backup config

### Expected Results After Rebuild:
✅ Ctrl key works normally (macos-keys removed)
✅ Can use sudo with password "temp123"
✅ Home-manager uses correct persistence module
✅ Sessions persist across reboots (.mozilla, .keyrings, etc.)
✅ time-machine service installed and configured
✅ Fish abbreviations available (nos, ht, hts, etc.)

## Troubleshooting

**If rebuild fails with "dirty git tree":**
```bash
# From rescue mode
cd /run/media/lessuseless/Ventoy/nixos-configs/dendrix/lul
git status
git add -A
git commit -m "Emergency rescue mode rebuild"
# Then retry rebuild
```

**If mount points are wrong:**
```bash
# Check current mounts
findmnt -t btrfs

# Your subvolumes:
# @root -> /
# @nix -> /nix
# @persist -> /persist
# @log -> /var/log
# @snapshots -> /.snapshots
```

**If rebuild succeeds but can't boot:**
- The configuration should be stable, it's the same as before + fixes
- Check boot logs: `journalctl -b -p err`

## Emergency Rollback

If something goes wrong:

```bash
# List available generations
nix-env -p /nix/var/nix/profiles/system --list-generations

# Rollback to previous generation
nixos-rebuild switch --rollback

# Or boot a specific generation from GRUB menu
# (older generations appear in "NixOS - Old Configurations" submenu)
```

---

**After completing the rescue rebuild, you can delete this file.**
